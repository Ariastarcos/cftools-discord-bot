// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  // Note: You will need to declare a binary target for the Prisma Client
  // when you deploy to Docker, Vercel, AWS Lambda, Google Cloud Functions, Azure Functions,
  // or similar
  // binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

model User {
  id      String   @id @unique
  members Member[]
}

model Member {
  id      String @id @unique @default(cuid())
  userId  String
  user    User   @relation(fields: [userId], references: [id])
  guildId String
  guild   Guild  @relation(fields: [guildId], references: [id])
}

model Guild {
  id      String   @id @unique
  Members Member[]

  adminRoleId       String?
  adminLogChannelId String?
  modRoleId         String?
  modLogChannelId   String?

  autoRoleIds String[]

  memberJoinChannelId String?
  memberJoinEmbed     Embed?  @relation("MemberJoinEmbed", fields: [memberJoinEmbedId], references: [id])
  memberJoinEmbedId   Int?

  memberLeaveChannelId String?
  memberLeaveEmbed     Embed?  @relation("MemberLeaveEmbed", fields: [memberLeaveEmbedId], references: [id])
  memberLeaveEmbedId   Int?
}

model CommandCooldown {
  id         Int        @id @default(autoincrement())
  cooldownId String     @unique
  duration   Int
  usages     DateTime[]
}

// Configurable Messages for users
// Check out the join/leave feed for an example
model Embed {
  id            Int          @id @default(autoincrement())
  messageText   String?
  color         Int?
  authorName    String?
  authorIconURL String?
  authorURL     String?
  title         String?
  description   String?
  url           String?
  imageURL      String?
  thumbnailURL  String?
  footerText    String?
  footerIconURL String?
  fields        EmbedField[]

  memberJoinEmbed  Guild[] @relation("MemberJoinEmbed")
  memberLeaveEmbed Guild[] @relation("MemberLeaveEmbed")
}

model EmbedField {
  id      Int     @id @unique @default(autoincrement())
  name    String
  value   String
  inline  Boolean
  Embed   Embed?  @relation(fields: [embedId], references: [id])
  embedId Int?
}

model CommandStatistics {
  id        Int    @id @unique @default(autoincrement())
  type      Int
  commandId String @unique

  usages      DateTime[] @default([])
  lastUsedAt  DateTime?
  firstUsedAt DateTime?

  errorCount  Int       @default(0)
  lastError   String?
  lastErrorAt DateTime?

  runtimeTotal        Float?
  runtimeMax          Float?
  runtimeMin          Float?
  runtimeMean         Float?
  runtimeMedian       Float?
  runtimeVariance     Float?
  runtimeStdDeviation Float?
}

enum WebhookEventType {
  RCON_RESTRICTED
  RCON_AUTHENTICATION_ERROR

  GAMESERVER_DOWNTIME
  GAMESERVER_DOWNTIME_CLEARED
  GAMESERVER_MOD_UPDATE

  USER_JOIN
  USER_LEAVE
  USER_KICKED
  USER_CHAT

  PLAYER_KILL
  PLAYER_DAMAGE
  PLAYER_DEATH
  PLAYER_DEATH_INFECTED
  PLAYER_DEATH_ENVIRONMENT
  PLAYER_DEATH_STARVATION
  PLAYER_DEATH_ANIMAL
  PLAYER_DEATH_EXPLOSION
  PLAYER_DEATH_OBJECT
  PLAYER_DEATH_FALLDAMAGE
  PLAYER_DEATH_BLOOD
  PLAYER_SUICIDE
  PLAYER_PLACE
  PLAYER_INTERACT
}

model WebhookEvent {
  id        Int     @id @unique @default(autoincrement())
  serverId  String
  deliveryId String @unique
  eventType WebhookEventType
  data      Json
  createdAt DateTime @default(now())

  @@index([serverId])
}